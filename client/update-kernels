#!/bin/sh -e

# this script is run either chrooted on the server, or by a client with write
# access to the NFS mount point. (much of this code was originally in
# server/ltsp-update-kernels). --vagrant 20060801

BOOT=/boot
if which mkelf-linux >/dev/null; then
    for kernel in $BOOT/vmlinuz*; do
        basename=$(basename "$kernel")

        if [ "$basename" = "vmlinuz" ]; then
            initrd=$BOOT/initrd.img
            nbi=$BOOT/nbi.img
        elif [ "$basename" = "vmlinuz.old" ]; then
            initrd=$BOOT/initrd.img.old
            nbi=$BOOT/nbi.img.old
        else
            version=${basename##vmlinuz-}
            initrd=$BOOT/initrd.img-$version
            nbi=$BOOT/nbi.img-$version
        fi

        if [ -f "$initrd" ]; then
            mkelf-linux --ip=dhcp -o $nbi $kernel $initrd
        else
            mkelf-linux --ip=dhcp -o $nbi $kernel
        fi
    done
else
    echo "Skipping etherboot images.  Install the mknbi package if you need them."
fi

# TODO merge the mkelf-linux and netabootwrap code
if which netabootwrap >/dev/null; then
    for kernel in $BOOT/vmlinuz*; do
        basename=$(basename "$kernel")

        if [ "$basename" = "vmlinuz" ]; then
            initrd=$BOOT/initrd.img
            nbi=$BOOT/nbi.img
        else
            version=${basename##vmlinuz-}
            initrd=$BOOT/initrd.img-$version
            nbi=$BOOT/nbi.img-$version
        fi
        # TODO: work around for debian bug #270801
        if [ -f "$initrd" ]; then
            netabootwrap -t $nbi -k $kernel -i $initrd
        else
            netabootwrap -t $nbi -k $kernel
        fi
    done
else
    echo "Skipping netabootwrap images.  Install the aboot package if you need them."
fi

if which elftoaout >/dev/null ; then
    for kernel in $BOOT/vmlinuz*; do
        basename=$(basename "$kernel")
        SUB_ARCH=$(uname -m)
        piggyback_cmd=""
        case $SUB_ARCH in
            sparc64) piggyback_cmd=piggyback64 ;;
            sparc32) piggyback_cmd=piggyback32 ;;
        esac
        if [ "$basename" = "vmlinuz" ]; then
            initrd=$BOOT/initrd.img
            sysmap=$BOOT/System.map
            nbi=$BOOT/nbi.$SUB_ARCH.img
        else
            version=${basename##vmlinuz-}
            initrd=$BOOT/initrd.img-$version
            sysmap=$BOOT/System.map-$version
            nbi=$BOOT/nbi.$SUB_ARCH.img-$version
        fi
        # TODO: proper tempfile handline
        gzip -cd $kernel > $nbi.tmp
        elftoaout -o $nbi $nbi.tmp
        if [ -f "$initrd" ]; then
            $piggyback_cmd $nbi $sysmap $initrd
        else
            $piggyback_cmd $nbi $sysmap
        fi
    done
else
    echo "Skipping sparc piggyback images. Install the sparc-utils package if you need them."
fi
