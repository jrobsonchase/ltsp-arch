#!/bin/sh -e

# this script is run either chrooted on the server, or by a client with write
# access to the NFS mount point. (much of this code was originally in
# server/ltsp-update-kernels). --vagrant 20060801

BOOT=/boot
for kernel in $BOOT/vmlinu* ; do
    basename=$(basename "$kernel")

    if [ "$basename" = "vmlinuz" ]; then
        initrd=initrd.img
        nbi=nbi.img
    elif [ "$basename" = "vmlinuz.old" ]; then
        initrd=initrd.img.old
        nbi=nbi.img.old
    else
        version=${basename##vmlinuz-}
        initrd=initrd.img-$version
        nbi=nbi.img-$version
    fi
    if [ -L "$kernel" ]; then
        basename="$(readlink $kernel)"
        if [ -f "$BOOT/$basename" ]; then
            version=${basename##vmlinuz-}
            ln -sf $nbi-$version $BOOT/$nbi
        fi
    else
        if which mkelf-linux >/dev/null; then
            if [ -f "$BOOT/$initrd" ]; then
                mkelf-linux --ip=dhcp -o $BOOT/$nbi $kernel $BOOT/$initrd
            else
                mkelf-linux --ip=dhcp -o $BOOT/$nbi $kernel
            fi
        else
            if [ -z "$mkelf_seen" ]; then
                echo "Skipping etherboot images.  Install the mknbi package if you need them."
                mkfelf_seen=true
            fi
        fi
        if which netabootwrap >/dev/null; then
            if [ -f "$BOOT/$initrd" ]; then
                netabootwrap -t $BOOT/$nbi -k $kernel -i $BOOT/$initrd
            else
                netabootwrap -t $BOOT/$nbi -k $kernel
            fi
        else
            if [ -z "$netabootwrap_seen" ]; then
                echo "Skipping netabootwrap images.  Install the aboot package if you need them."
                netabootwrap_seen=true
            fi
        fi
    fi
done

if which elftoaout >/dev/null ; then
    for kernel in $BOOT/vmlinuz*; do
        basename=$(basename "$kernel")
        SUB_ARCH=$(uname -m)
        piggyback_cmd=""
        case $SUB_ARCH in
            sparc64) piggyback_cmd=piggyback64 ;;
            sparc32) piggyback_cmd=piggyback32 ;;
        esac
        if [ "$basename" = "vmlinuz" ]; then
            initrd=$BOOT/initrd.img
            sysmap=$BOOT/System.map
            nbi=$BOOT/nbi.$SUB_ARCH.img
        else
            version=${basename##vmlinuz-}
            initrd=$BOOT/initrd.img-$version
            sysmap=$BOOT/System.map-$version
            nbi=$BOOT/nbi.$SUB_ARCH.img-$version
        fi
        # TODO: proper tempfile handline
        gzip -cd $kernel > $nbi.tmp
        elftoaout -o $nbi $nbi.tmp
        if [ -f "$initrd" ]; then
            $piggyback_cmd $nbi $sysmap $initrd
        else
            $piggyback_cmd $nbi $sysmap
        fi
    done
else
    echo "Skipping sparc piggyback images. Install the sparc-utils package if you need them."
fi
