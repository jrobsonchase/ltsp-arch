#!/bin/sh

set -e

TFTPBOOT=/var/lib/tftpboot/ltsp
PXECFG=$TFTPBOOT/pxelinux.cfg
LTSPROOT=/opt/ltsp
SERVER=$(getent hosts $(hostname) | awk '{ ip = $1 } END { print ip }')

for file in $LTSPROOT/*/boot/vmlinuz* $LTSPROOT/*/boot/initrd.img*; do
    cp -a -v "$file" $TFTPBOOT
done

cp /usr/lib/syslinux/pxelinux.0 $TFTPBOOT
if [ ! -d $PXECFG ]; then
    mkdir $PXECFG
fi
cat > $PXECFG/default <<"EOF"
DEFAULT vmlinuz nfsroot=$SERVER:$LTSPROOT/i386 ro initrd=initrd.img
EOF

#for file in $TFTPBOOT/*; do
#    found=""
#    for master in $LTSPROOT/*/boot/$(basename "$file"); do
#        if [ -e "$master" ]; then
#            found=1
#            break
#        fi
#    done
#
#    if [ -z "$found" ]; then
#        rm -f "$file"
#    fi
#done
