#!/bin/sh

set -e

TFTPDIR=${TFTPDIR:-/var/lib/tftpboot/}
TFTPBOOT=${TFTPBOOT:-"$TFTPDIR/ltsp"}
LTSPROOT=${LTSPROOT:-"/opt/ltsp"}

if [ ! -d $TFTPDIR ] ; then
    mkdir -p $TFTPDIR
fi

if [ -d "$TFTPBOOT" ]; then
    echo "moving aside old $TFTPBOOT dir"
    mv $TFTPBOOT $TFTPBOOT.old
fi

if [ ! -L $TFTPBOOT ]; then
    # linking ltsp dir
    ln -s $LTSPROOT $TFTPBOOT
fi

ALL_CHROOTS="$@"
ALL_CHROOTS=${ALL_CHROOTS:-"$(find $LTSPROOT -mindepth 1 -maxdepth 1 -type d)"}

for CHROOT in $ALL_CHROOTS ; do
    if [ -x $CHROOT/bin/true ]; then
        echo "looking for files in: $CHROOT"
    else
        # without /bin/true, it is almost certainly not a chroot
        break
    fi

    export CHROOT_NAME="$(basename $CHROOT)"

    # check for compatible (i.e. chrootable) architecture
    if chroot $CHROOT /bin/true ; then
        # update kernels for the chroot
        if [ -x "$CHROOT/usr/lib/ltsp/update-kernels" ]; then
            chroot "$CHROOT" /usr/lib/ltsp/update-kernels
        fi
    fi

    if [ -f $CHROOT/boot/yaboot ]; then
        if [ -f $CHROOT/boot/yaboot.conf ]; then
            # yaboot requires the files in a specific location,
            # link them so they appear there.
            ln -s $TFTPBOOT/$CHROOT/boot/yaboot $TFTPDIR
            ln -s $TFTPBOOT/$CHROOT/boot/yaboot.conf $TFTPDIR
        else
            echo "WARNING: yaboot present but not configured."
        fi
    fi  
done
