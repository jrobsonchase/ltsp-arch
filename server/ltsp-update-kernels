#!/bin/sh

set -e

# Make sure the copied files are readable by all
umask 022

TFTPDIR=/var/lib/tftpboot/
TFTPBOOT=$TFTPDIR/ltsp
test -z "$LTSPROOT" && LTSPROOT=/opt/ltsp

if [ ! -d $TFTPBOOT ] ; then
    echo "error: Directory $TFTPBOOT is missing.  Unable to continue"
    exit 1
fi

ALL_CHROOTS="$(find $LTSPROOT -mindepth 1 -maxdepth 1 -type d)"

for CHROOT in $ALL_CHROOTS ; do
    # check for compatible (i.e. chrootable) architecture
    if chroot $CHROOT /bin/true ; then
        # update kernels for the chroot
        if [ -x "$CHROOT/usr/lib/ltsp/update-kernels" ]; then
            chroot "$CHROOT" /usr/lib/ltsp/update-kernels
        fi
    fi

    EXTRA_FILES=""
    if [ -f $CHROOT/boot/yaboot.conf ]; then
        if [ -f $CHROOT/boot/yaboot ]; then
            cp -a -v $CHROOT/boot/yaboot.conf $TFTPDIR
            EXTRA_FILES="$CHROOT/boot/yaboot"
        else
            echo "WARNING: not configuring yaboot: $CHROOT/boot/yaboot not found"
        fi
    fi
    if [ -f $CHROOT/boot/pxelinux.cfg/default ]; then 
        if [ -f $CHROOT/boot/pxelinux.0 ]; then
            EXTRA_FILES="$CHROOT/boot/pxelinux.0 $CHROOT/boot/pxelinux.cfg/default $EXTRA_FILES"
        else
            echo "WARNING: not configuring pxelinux: $CHROOT/boot/pxelinux.0 not found"
        fi
    fi
    CHROOT_NAME="$(basename $CHROOT)"
    mkdir -p $TFTPBOOT/$CHROOT_NAME
    for file in $CHROOT/boot/vmlinu* $CHROOT/boot/initrd.img* $CHROOT/boot/System.map* $EXTRA_FILES ; do
        cp -a -v "$file" $TFTPBOOT/$CHROOT_NAME
    done
done
