#!/bin/sh

set -e

# Make sure the copied files are readable by all
umask 022

TFTPBOOT=/var/lib/tftpboot/ltsp
test -z "$LTSPROOT" && LTSPROOT=/opt/ltsp

if [ ! -d $TFTPBOOT ] ; then
    echo "error: Directory $TFTPBOOT is missing.  Unable to continue"
    exit 1
fi

ALL_CHROOTS="$(find $LTSPROOT -type d -mindepth 1 -maxdepth 1)"

for CHROOT in $ALL_CHROOTS ; do
    # check for compatible (i.e. chrootable) architecture
    if chroot $CHROOT /bin/true ; then
        # update kernels for the chroot
        if [ -x "$CHROOT/usr/lib/ltsp/update-kernels" ]; then
            chroot "$CHROOT" /usr/lib/ltsp/update-kernels
        fi
    fi
    # TODO: copy pxelinux and yaboot configuration, too.
    for file in $CHROOT/boot/vmlinu* $CHROOT/boot/initrd.img* $CHROOT/boot/System.map* ; do
        cp -a -v "$file" $TFTPBOOT/$(basename $CHROOT)
    done
done
