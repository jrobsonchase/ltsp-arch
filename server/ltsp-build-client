#!/bin/sh

set -e

LC_ALL=C
export LC_ALL

# set defaults
test -z "$ROOT" && ROOT=/opt/ltsp/$(dpkg --print-architecture)
test -z "$DIST" && DIST=sarge
case $DIST in
  breezy) 
    test -z "$COMPONENTS" && COMPONENTS="main restricted"
    test -z "$MIRROR" && MIRROR="http://us.archive.ubuntu.com/ubuntu"
    test -z "$EARLY_PACKAGES" && EARLY_PACKAGES="x-window-system-core ltsp-client discover1 laptop-detect mdetect xresprobe"
    test -z "$LATE_PACKAGES" && LATE_PACKAGES="linux"
    ;;
esac
test -z "$COMPONENTS" && COMPONENTS="main"
test -z "$MIRROR" && MIRROR="http://http.us.debian.org/debian"
test -z "$EARLY_PACKAGES" && EARLY_PACKAGES="x-window-system-core ltsp-client discover1 mdetect xresprobe udhcpc udev devfsd"
test -z "$LATE_PACKAGES" && LATE_PACKAGES="kernel-image-netbootable"

# Install base packages
debootstrap $DIST $ROOT $MIRROR

# Root password is empty by default, lock it
chroot $ROOT passwd -l root

# Always load mousedev
echo mousedev >> $ROOT/etc/modules

cat <<EOF > $ROOT/etc/apt/sources.list
deb $MIRROR $DIST $COMPONENTS
EOF

chroot $ROOT apt-get update
chroot $ROOT apt-get -y dist-upgrade

DEBIAN_FRONTEND=noninteractive
export DEBIAN_FRONTEND

# Install remaining packages
chroot $ROOT apt-get -y install $EARLY_PACKAGES

# Setup for kernel install
cat <<EOF > $ROOT/etc/kernel-img.conf
warn_initrd = No
do_symlinks = yes
relative_links = yes
link_in_boot = yes
do_bootloader = no
EOF

if [ -f $ROOT/etc/mkinitramfs/initramfs.conf ]; then
  # configuring for initramfs-tools
  echo "ramdisk=/usr/sbin/mkinitramfs" >> $ROOT/etc/kernel-img.conf
  sed -i -e 's/^BOOT=.*$/BOOT=nfs/' $ROOT/etc/mkinitramfs/initramfs.conf
elif [ -f $ROOT/etc/mkinitrd/mkinitrd.conf ]; then
  # configuring for initrd-netboot-tools
  sed -i -e 's/^ROOT=.*$/ROOT=""/' -e 's/^MODULES=.*$/MODULES=none/' $ROOT/etc/mkinitrd/mkinitrd.conf
fi

# Install additional packages, such as the the kernel
chroot $ROOT apt-get -y install $LATE_PACKAGES

LTSPROOT="$(dirname $ROOT)" ltsp-update-kernels
clients="$ROOT" ltsp-update-sshkeys

rm -f $ROOT/etc/hostname

chroot $ROOT apt-get clean
