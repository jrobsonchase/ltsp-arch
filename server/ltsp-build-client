#!/bin/sh

set -e

export LC_ALL=C

ROOT="$1"
DIST="$2"
MIRROR="$3"

debootstrap $DIST $ROOT $MIRROR

chroot $ROOT passwd -l root
echo mousedev | tee -a $ROOT/etc/modules

cat <<EOF > $ROOT/etc/apt/sources.list
deb $MIRROR $DIST main restricted
EOF

chroot $ROOT apt-get update

cat <<EOF > $ROOT/etc/kernel-img.conf
warn_initrd = No
do_symlinks = yes
relative_links = yes
link_in_boot = yes
do_bootloader = no
EOF

# XXX
cat <<'EOF' > $ROOT/usr/sbin/mkinitrd
#!/bin/sh

path="$2"
touch "$path"
exit 0
EOF

chroot $ROOT apt-get -y install x-window-system-core linux-386 # ltsp-client

rm -f $ROOT/etc/hostname
cat <<'EOF' > $ROOT/etc/hosts
127.0.0.1 localhost
EOF

cat <<'EOF' > $ROOT/etc/network/interfaces
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
EOF

exit 0
