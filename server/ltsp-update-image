#!/bin/sh
# copyright 2007 Canonical LTD., Oliver Grawert <ogra@ubuntu.com>
# distributed under the terms of the GNU General Public License version 2
# or any later version.  

# generates a squashfs image from an ltsp chroot to be served by an inetd driven
# nbd-server process, note that ltsp-client needs to support nbd booting fori
# that. All versions of the ltsp-client package past 5.0.11 should be able
# to do that

#
# Handle command line args
#

ARGS=$(getopt -o b:p:a: --long base:,port:,arch: -n $0 -- "$@")

[ $? != 0 ] && exit 1

eval set -- "${ARGS}"

while true ; do
    case "$1" in
        -b|--base) BASE=$2 ; shift 2;;
        -p|--port) PORT=$2 ; shift 2;;
        -a|--arch) ARCH=$2 ; shift 2;;
        --) shift ; break ;;
        *) echo "Internal error!" ; exit 1 ;;
    esac
done

# defaults
BASE=${BASE:-"/opt/ltsp/"}
PORT=${PORT:-"2000"}
[ -z "${ARCH}" ] && ARCH=$(dpkg --print-architecture)

IMGDIR="${BASE}/images"
CONFFILE="/usr/share/initramfs-tools/conf.d/ltsp"
CHROOT="${BASE}/${ARCH}"

# source config file
[ -f /etc/default/ltsp-update-image ] && . /etc/default/ltsp-update-image

# make sure the images dir exists
[ ! -d ${IMGDIR} ] && mkdir -p ${IMGDIR}

# find out if we are really an nbd client and if so, build the image
if [ -d "${CHROOT}" ]; then
    if $(grep nbd "${CHROOT}/${CONFFILE}" > /dev/null 2>&1); then
        IMAGE="${IMGDIR}/${ARCH}.img"
        rm "${IMAGE}"
        mksquashfs "${CHROOT}" "${IMAGE}.tmp" -e cdrom
        mv "${IMAGE}.tmp" "${IMAGE}"
        chmod 0744 "${IMAGE}"
    fi
fi

# Make sure hosts.allow has the keepalive option for nbdrootd
grep nbdrootd /etc/hosts.allow > /dev/null 2>&1 || \
    echo 'nbdrootd: ALL: keepalive' >> /etc/hosts.allow

# If the image is already in inetd.conf, and not commented out, exit ok
grep ${IMAGE} /etc/inetd.conf | grep -v "^#" > /dev/null 2>&1 && exit 0

# Check and see if our desired port is already there.
grep ^${PORT} /etc/inetd.conf > /dev/null 2>&1 &&
    echo "Error: port ${PORT} is already defined in inetd.conf" &&
    exit 1

# Update inetd.conf
update-inetd --group LTSP --add "${PORT}                   stream  tcp\
    nowait  nobody /usr/sbin/tcpd /usr/sbin/nbdrootd ${IMAGE}"
