case "$MODE" in
    finalization)
        if [ -x "$ROOT/usr/sbin/mkinitramfs" ] && [ -f "$ROOT/etc/mkinitramfs/initramfs.conf" ]; then
            INITRAMFSCONF="$ROOT/etc/mkinitramfs/initramfs.conf"
        elif [ -x "$ROOT/usr/sbin/mkinitramfs-tools" ] && [ -f "$ROOT/etc/mkinitramfs-tools/initramfs.conf" ]; then
            INITRAMFSCONF="$ROOT/etc/mkinitramfs-tools/initramfs.conf"
        elif [ -x "$ROOT/usr/sbin/mkinitramfs" ] && [ -f "$ROOT/etc/initramfs-tools/initramfs.conf" ]; then
            INITRAMFSCONF="$ROOT/etc/initramfs-tools/initramfs.conf"
            if [ -d "$ROOT/etc/initramfs-tools/conf.d" ]; then
                INITRAMFSCONF_DIR="$ROOT/etc/initramfs-tools/conf.d"
            fi
        fi

        if [ -n "$INITRAMFSCONF" ]; then
            # We need to set the boot method since LTSP supports NBI
            # booting too and in this specific case we cannot pass
            # boot params. Due space limitations we set to use just
            # netboot related modules in initramfs.
            if [ -d "$INITRAMFSCONF_DIR" ]; then
                if [ -f "$INITRAMFSCONF_DIR/ltsp" ]; then
                    sed -e 's/^BOOT=.*$/BOOT=nfs/' \
                        -e 's/MODULES=.*$/MODULES=netboot/' -i $INITRAMFSCONF_DIR/ltsp
                else
                    echo BOOT=nfs >> "$INITRAMFSCONF_DIR/ltsp"
                    echo BOOT=netboot >> "$INITRAMFSCONF_DIR/ltsp"
                fi
            else
                sed -e 's/^BOOT=.*$/BOOT=nfs/' \
                    -e 's/MODULES=.*$/MODULES=netboot/' -i $INITRAMFSCONF
            fi

            # Workaround a bug in initramfs-tools nfsmount
            if [ -f $ROOT/usr/share/initramfs-tools/scripts/nfs ]; then
                sed -e 's/NFSOPTS="-o retrans=10"/NFSOPTS="-o retrans=10,nolock"/' \
                    -e 's/nfsmount /mount /' -i $ROOT/usr/share/initramfs-tools/scripts/nfs
            fi
        elif [ -f $ROOT/etc/mkinitrd/mkinitrd.conf ] && [ -x $ROOT/usr/sbin/mkinitrd ] && [ -d /usr/share/doc/initrd-netboot-tools] ; then
            # configuring for initrd-netboot-tools
            sed -e 's/^ROOT=.*$/ROOT=""/' \
                -e 's/^MODULES=.*$/MODULES=none/' -i $ROOT/etc/mkinitrd/mkinitrd.conf
        fi
        ;;
esac
