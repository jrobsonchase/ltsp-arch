case "$MODE" in
    finalization)
        if [ -x "$ROOT/usr/sbin/mkinitramfs" ] && [ -f "$ROOT/etc/mkinitramfs/initramfs.conf" ]; then
            INITRAMFSCONF="$ROOT/etc/mkinitramfs/initramfs.conf"
        elif [ -x "$ROOT/usr/sbin/mkinitramfs-tools" ] && [ -f "$ROOT/etc/mkinitramfs-tools/initramfs.conf" ]; then
            INITRAMFSCONF="$ROOT/etc/mkinitramfs-tools/initramfs.conf"
        elif [ -x "$ROOT/usr/sbin/mkinitramfs" ] && [ -f "$ROOT/etc/initramfs-tools/initramfs.conf" ]; then
            INITRAMFSCONF="$ROOT/etc/initramfs-tools/initramfs.conf"
        fi

        if [ -n "$INITRAMFSCONF" ]; then
            # We need to set the boot method since LTSP supports NBI
            # booting too and in this specific case we cannot pass
            # boot params. Due space limitations we set to use just
            # netboot related modules in initramfs.
            sed -e 's/^BOOT=.*$/BOOT=nfs/' \
                -e 's/MODULES=.*$/MODULES=netboot/' -i $INITRAMFSCONF

            # Workaround a bug in initramfs-tools nfsmount
            if [ -f $ROOT/usr/share/initramfs-tools/scripts/nfs ]; then
                sed -e 's/NFSOPTS="-o retrans=10"/NFSOPTS="-o retrans=10,nolock"/' \
                    -e 's/nfsmount /mount /' -i $ROOT/usr/share/initramfs-tools/scripts/nfs
            fi
        elif [ -f $ROOT/etc/mkinitrd/mkinitrd.conf ] && [ -x $ROOT/usr/sbin/mkinitrd ]; then
            # configuring for initrd-netboot-tools
            sed -e 's/^ROOT=.*$/ROOT=""/' \
                -e 's/^MODULES=.*$/MODULES=none/' -i $ROOT/etc/mkinitrd/mkinitrd.conf
        fi
        ;;
esac
