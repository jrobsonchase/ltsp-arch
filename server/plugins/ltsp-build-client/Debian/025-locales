case $MODE in
    commandline)
        add_option "locale" "`eval_gettext "Set the default locale"`" "advanced" "true"
        ;;
    configure)
        if [ -n "$option_locale_value" ]; then
            LOCALE="$option_locale_value"
        fi
        ;;
    before-install)
        # include locales in initial deboostrap
        if [ -n "$INCLUDE" ]; then
            INCLUDE="locales"
        else
            INCLUDE="$INCLUDE,locales"
        fi
        ;;
    install)
        if [ -f /etc/locale.gen ]; then
            cp /etc/locale.gen $ROOT/etc/
        fi
        if [ -f /etc/default/locale ]; then
            cp /etc/default/locale $ROOT/etc/default
        fi

        if [ -f /etc/default/console-setup ]; then
            cp /etc/default/console-setup $ROOT/etc/default/console-setup
        fi
        
        if [ -n "$LOCALE" ]; then
            export LANG=$(echo "$LOCALE" | awk '{print $1}')
            echo "$LOCALE" >> $ROOT/etc/locale.gen
            echo "LANG=$LANG" >> $ROOT/etc/default/locale
        fi

        if [ -f $ROOT/etc/locale.gen ] && [ -x $ROOT/usr/sbin/locale-gen ] ; then
            DEBIAN_FRONTEND=noninteractive DEBIAN_PRIORITY=critical LC_ALL=C chroot $ROOT /usr/sbin/locale-gen
        fi

        # set debian-installer/keymap question in the chroot if present on the server
        debian_installer_keymap="$(debconf-get-selections | grep debian-installer/keymap)"
        if [ -n "$debian_installer_keymap" ]; then
            echo "$debian_installer_keymap" | chroot $ROOT debconf-set-selections
        fi
        ;;
esac
