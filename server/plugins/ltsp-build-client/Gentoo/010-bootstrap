case "$MODE" in
    commandline)
        add_option "quickstart-profile" "`eval_gettext "Path to Quickstart profile"`" "advanced" "true"
        add_option "quickstart-debug" "`eval_gettext "Debug Quickstart"`" "advanced" "false"
        add_option "quickstart-verbose" "`eval_gettext "Show external command output"`" "advanced" "false"
        add_option "quickstart-host" "`eval_gettext "Get profile from a Quickstart server"`" "advanced" "true"
    ;;
    configure)
        if [ -n "$option_quickstart_profile_value" ] || [ -n "$QUICKSTART_PROFILE" ]; then
            QUICKSTART_PROFILE=${option_quickstart_profile_value:-$QUICKSTART_PROFILE}
            printf "`eval_gettext "Manual Quickstart: %s"`\n" $QUICKSTART_PROFILE
        else
            QUICKSTART_PROFILE="/etc/ltsp/quickstart/profile.qs"
            printf "`eval_gettext "Default Quickstart profile: %s"`\n" $QUICKSTART_PROFILE
        fi

        if [ ! -e $QUICKSTART_PROFILE ]; then
            printf "`eval_gettext "ERROR: %s does not exist"`\n" $QUICKSTART_PROFILE
            exit 1
        fi

        QUICKSTART_ARGS=""
        if [ -n "$option_quickstart_debug_value" ] || [ "${QUICKSTART_DEBUG}" = true ]; then
            QUICKSTART_ARGS="$QUICKSTART_ARGS --debug"
        fi
        if [ -n "$option_quickstart_verbose_value" ] || [ "${QUICKSTART_VERBOSE}" = true ]; then
            QUICKSTART_ARGS="$QUICKSTART_ARGS --verbose"
        fi
        if [ -n "$option_quickstart_host_value" ] || [ -n "$QUICKSTART_HOST" ]; then
            QUICKSTART_ARGS="$QUICKSTART_ARGS --client ${option_quickstart_host_value:-$QUICKSTART_HOST}"
        fi
    ;;
    install)
        printf "`eval_gettext "Installing into: %s"`\n" $ROOT
        
        # TODO: figure out why we need to set ROOT=""
        # ROOT is somehow used in emerge, causing emerged installs
        # to go into /chroot/chroot, resetting until quickstart is done.
        TEMPROOT=${ROOT}        
        ROOT=""

        PACKAGES="${PACKAGES}" STAGE_URI="${STAGE_URI}" MIRRORS="${MIRRORS}" \
        MAKEOPTS="${MAKEOPTS}" LOCALE="${LOCALE}" BASE="${BASE}" \
        ARCH="${ARCH}" NAME="${CHROOT}" \
        quickstart $QUICKSTART_ARGS $QUICKSTART_PROFILE
        # And reset to the original value
        ROOT=${TEMPROOT}
    ;;
    after-install)
        # removing stage symlink
        STAGE_FILE=$( basename ${STAGE_URI} )
        if [ -L ${ROOT}/${STAGE_FILE} ]; then
            rm ${ROOT}/${STAGE_FILE}
        fi
    ;;
esac
