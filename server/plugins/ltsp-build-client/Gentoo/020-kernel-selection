case "$MODE" in
    before-install)
		# Where is genkernel?
		GK_PREFIX=/usr/share/genkernel/

        GK_ARGS="
            --bootdir=$ROOT/boot \
            --install-mod-path=$ROOT \
            --links \
            --makeopts=-j${JOBS} \
            --debuglevel=5 \
            --unionfs \
            --portmap \
            --tempdir=/var/cache/genkernel/tmp \
            --kbuild-output=/var/cache/genkernel/kbuild \
			--internal-uclibc
            --no-clean
            "
            #--menuconfig \

        # Run genkernel to create and install kernel image
        $GK_PREFIX/genkernel \
            $GK_ARGS \
            kernel::

        # Add networking drivers to configs/generic/modules_load.gk so they
        # get added to the initramfs; ditto for nfs
        for MOD in $(find $ROOT/lib/modules/*/kernel/drivers/net/ \
            -name *.ko | sed -e "s:.*/::" -e "s:\.ko::"); do
            MODULE_NET="$MODULE_NET $MOD"
        done

        sed -i \
            -e "s~^\(module-net[[:space:]]*:=\).*~\1 $MODULE_NET~g" \
            -e "s~^\(module-nfs[[:space:]]*:=\).*~\1 nfs~g" \
            $GK_PREFIX/configs/generic/modules_load.gk

        # Run genkernel to create and install initial ram disk
        $GK_PREFIX/genkernel \
            $GK_ARGS \
            initramfs::
	;;
esac
